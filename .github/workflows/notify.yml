name: Notify subscribers of new post

on:
  push:
    branches: ["main"]
    paths:
      - "content/posts/**.md"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new posts
        id: detect
        run: |
          # Find newly added post files
          NEW_POSTS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'content/posts/*.md' || true)
          if [ -z "$NEW_POSTS" ]; then
            echo "No new posts found"
            echo "has_new=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Use the first new post
          POST_FILE=$(echo "$NEW_POSTS" | head -1)
          echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT
          echo "has_new=true" >> $GITHUB_OUTPUT

          # Extract title from front matter
          TITLE=$(sed -n 's/^title: *"\(.*\)"/\1/p' "$POST_FILE" | head -1)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # Extract slug from filename
          SLUG=$(basename "$POST_FILE" .md)
          echo "slug=$SLUG" >> $GITHUB_OUTPUT

          # Extract description if present
          DESC=$(sed -n 's/^description: *"\(.*\)"/\1/p' "$POST_FILE" | head -1)
          echo "desc=$DESC" >> $GITHUB_OUTPUT

      - name: Fetch subscriber list
        if: steps.detect.outputs.has_new == 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          curl -sf -H "Authorization: Bearer ${GH_PAT}" \
            "https://api.github.com/gists/${GIST_ID}" \
            | jq -r '.files["subscribers.txt"].content' > /tmp/subscribers.txt
          echo "Loaded $(wc -l < /tmp/subscribers.txt | tr -d ' ') subscribers"

      - name: Send emails
        if: steps.detect.outputs.has_new == 'true'
        env:
          GMAIL_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          POST_TITLE: ${{ steps.detect.outputs.title }}
          POST_SLUG: ${{ steps.detect.outputs.slug }}
          POST_DESC: ${{ steps.detect.outputs.desc }}
        run: |
          sudo apt-get install -y msmtp >/dev/null 2>&1

          # Configure msmtp for Gmail
          cat > ~/.msmtprc << MSMTP
          defaults
          auth           on
          tls            on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          logfile        ~/.msmtp.log

          account        gmail
          host           smtp.gmail.com
          port           587
          from           seahyingcong@gmail.com
          user           seahyingcong@gmail.com
          password       ${GMAIL_PASSWORD}

          account default : gmail
          MSMTP
          chmod 600 ~/.msmtprc

          POST_URL="https://seahyingcong.com/posts/${POST_SLUG}/"

          while IFS= read -r email; do
            email=$(echo "$email" | tr -d '[:space:]')
            [ -z "$email" ] && continue
            echo "Sending to $email..."

            cat << MAIL | msmtp "$email"
          From: Seah Ying Cong <seahyingcong@gmail.com>
          To: ${email}
          Subject: ${POST_TITLE}
          Content-Type: text/html; charset=utf-8

          <p>New post on <a href="https://seahyingcong.com">seahyingcong.com</a>:</p>
          <h2><a href="${POST_URL}">${POST_TITLE}</a></h2>
          ${POST_DESC:+<p>${POST_DESC}</p>}
          <p><a href="${POST_URL}">Read it here â†’</a></p>
          <hr>
          <p style="color: #999; font-size: 12px;">You're receiving this because you subscribed to my blog. Reply to unsubscribe.</p>
          MAIL

            sleep 1
          done < /tmp/subscribers.txt
          echo "Done sending to all subscribers"
